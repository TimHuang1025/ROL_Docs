"use strict";(self.webpackChunkgame_docs=self.webpackChunkgame_docs||[]).push([[205],{3664:(n,r,e)=>{e.r(r),e.d(r,{assets:()=>s,contentTitle:()=>o,default:()=>h,frontMatter:()=>t,metadata:()=>l,toc:()=>c});const l=JSON.parse('{"id":"\u5361\u724c/gacha-system","title":"\u62bd\u5361\u7cfb\u7edf","description":"\u7cfb\u7edf\u6982\u8ff0","source":"@site/docs/\u5361\u724c/gacha-system.md","sourceDirName":"\u5361\u724c","slug":"/\u5361\u724c/gacha-system","permalink":"/ROL_Docs/docs/\u5361\u724c/gacha-system","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":8,"frontMatter":{"id":"gacha-system","title":"\u62bd\u5361\u7cfb\u7edf","sidebar_label":"\u62bd\u5361\u7cfb\u7edf","sidebar_position":8},"sidebar":"tutorialSidebar","previous":{"title":"\u6280\u80fd\u7cfb\u7edf","permalink":"/ROL_Docs/docs/\u5361\u724c/card-skill-system"},"next":{"title":"\u5361\u724c\u5e93","permalink":"/ROL_Docs/docs/\u5361\u724c/card-inventory"}}');var i=e(4848),a=e(8453);const t={id:"gacha-system",title:"\u62bd\u5361\u7cfb\u7edf",sidebar_label:"\u62bd\u5361\u7cfb\u7edf",sidebar_position:8},o="\u62bd\u5361\u7cfb\u7edf",s={},c=[{value:"\u7cfb\u7edf\u6982\u8ff0",id:"\u7cfb\u7edf\u6982\u8ff0",level:2},{value:"\u7cfb\u7edf\u67b6\u6784",id:"\u7cfb\u7edf\u67b6\u6784",level:2},{value:"\u6838\u5fc3\u7ec4\u4ef6",id:"\u6838\u5fc3\u7ec4\u4ef6",level:2},{value:"GachaPanelController - \u4e3b\u63a7\u5236\u5668",id:"gachapanelcontroller---\u4e3b\u63a7\u5236\u5668",level:3},{value:"GachaPoolService - \u5361\u6c60\u670d\u52a1",id:"gachapoolservice---\u5361\u6c60\u670d\u52a1",level:3},{value:"\u6570\u636e\u6a21\u578b",id:"\u6570\u636e\u6a21\u578b",level:2},{value:"GachaPoolInfo - \u5361\u6c60\u4fe1\u606f",id:"gachapoolinfo---\u5361\u6c60\u4fe1\u606f",level:3},{value:"\u7f51\u7edc\u534f\u8bae",id:"\u7f51\u7edc\u534f\u8bae",level:3},{value:"\u62bd\u5361\u8bf7\u6c42",id:"\u62bd\u5361\u8bf7\u6c42",level:4},{value:"\u62bd\u5361\u54cd\u5e94",id:"\u62bd\u5361\u54cd\u5e94",level:4},{value:"\u62bd\u5361\u6d41\u7a0b",id:"\u62bd\u5361\u6d41\u7a0b",level:2},{value:"1. \u9009\u62e9\u5361\u6c60",id:"1-\u9009\u62e9\u5361\u6c60",level:3},{value:"2. \u68c0\u67e5\u8d44\u6e90",id:"2-\u68c0\u67e5\u8d44\u6e90",level:3},{value:"3. \u5904\u7406\u62bd\u5361\u7ed3\u679c",id:"3-\u5904\u7406\u62bd\u5361\u7ed3\u679c",level:3},{value:"\u5956\u52b1\u5904\u7406",id:"\u5956\u52b1\u5904\u7406",level:2},{value:"1. \u65b0\u5361\u4e0e\u788e\u7247\u8f6c\u6362",id:"1-\u65b0\u5361\u4e0e\u788e\u7247\u8f6c\u6362",level:3},{value:"2. \u5361\u724c\u89e3\u9501\u5904\u7406",id:"2-\u5361\u724c\u89e3\u9501\u5904\u7406",level:3},{value:"\u7ffb\u5361\u52a8\u753b",id:"\u7ffb\u5361\u52a8\u753b",level:2},{value:"GachaFlipAnimationController",id:"gachaflipanimationcontroller",level:3},{value:"\u5361\u6c60\u7ba1\u7406",id:"\u5361\u6c60\u7ba1\u7406",level:2},{value:"1. \u5361\u6c60\u5217\u8868\u6784\u5efa",id:"1-\u5361\u6c60\u5217\u8868\u6784\u5efa",level:3},{value:"2. \u9650\u65f6\u6d3b\u52a8\u5012\u8ba1\u65f6",id:"2-\u9650\u65f6\u6d3b\u52a8\u5012\u8ba1\u65f6",level:3},{value:"\u7f13\u5b58\u673a\u5236",id:"\u7f13\u5b58\u673a\u5236",level:2},{value:"\u5361\u6c60\u4fe1\u606f\u7f13\u5b58",id:"\u5361\u6c60\u4fe1\u606f\u7f13\u5b58",level:3},{value:"Banner\u56fe\u7247\u4e0b\u8f7d",id:"banner\u56fe\u7247\u4e0b\u8f7d",level:3},{value:"\u6d4b\u8bd5\u5de5\u5177",id:"\u6d4b\u8bd5\u5de5\u5177",level:2},{value:"\u83b7\u53d6\u6d4b\u8bd5\u8d44\u6e90",id:"\u83b7\u53d6\u6d4b\u8bd5\u8d44\u6e90",level:3},{value:"\u667a\u80fd\u7ed3\u679c\u663e\u793a",id:"\u667a\u80fd\u7ed3\u679c\u663e\u793a",level:2},{value:"\u7279\u6b8a\u89c4\u5219",id:"\u7279\u6b8a\u89c4\u5219",level:2},{value:"1. \u91cd\u590d\u5361\u724c\u8f6c\u6362",id:"1-\u91cd\u590d\u5361\u724c\u8f6c\u6362",level:3},{value:"2. \u4fdd\u5e95\u673a\u5236",id:"2-\u4fdd\u5e95\u673a\u5236",level:3},{value:"3. \u6d88\u8017\u4e0e\u6298\u6263",id:"3-\u6d88\u8017\u4e0e\u6298\u6263",level:3},{value:"4. \u5361\u6c60\u7c7b\u578b",id:"4-\u5361\u6c60\u7c7b\u578b",level:3},{value:"\u6ce8\u610f\u4e8b\u9879",id:"\u6ce8\u610f\u4e8b\u9879",level:2}];function d(n){const r={code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(r.header,{children:(0,i.jsx)(r.h1,{id:"\u62bd\u5361\u7cfb\u7edf",children:"\u62bd\u5361\u7cfb\u7edf"})}),"\n",(0,i.jsx)(r.h2,{id:"\u7cfb\u7edf\u6982\u8ff0",children:"\u7cfb\u7edf\u6982\u8ff0"}),"\n",(0,i.jsx)(r.p,{children:"\u62bd\u5361\u7cfb\u7edf\u63d0\u4f9b\u73a9\u5bb6\u83b7\u53d6\u5361\u724c\u7684\u4e3b\u8981\u9014\u5f84\uff0c\u652f\u6301\u5355\u62bd\u548c\u5341\u8fde\u62bd\uff0c\u5305\u542b\u591a\u4e2a\u5361\u6c60\u3001\u9650\u65f6\u6d3b\u52a8\u3001\u4fdd\u5e95\u673a\u5236\u548c\u7ffb\u5361\u52a8\u753b\u3002\u7cfb\u7edf\u901a\u8fc7\u670d\u52a1\u5668\u63a7\u5236\u6982\u7387\u548c\u5956\u52b1\uff0c\u786e\u4fdd\u516c\u5e73\u6027\u3002"}),"\n",(0,i.jsx)(r.h2,{id:"\u7cfb\u7edf\u67b6\u6784",children:"\u7cfb\u7edf\u67b6\u6784"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-mermaid",children:'graph TB\r\n    subgraph "UI\u5c42"\r\n        A[GachaPanelController] --\x3e B[\u5361\u6c60\u5217\u8868\u5c55\u793a]\r\n        A --\x3e C[\u62bd\u5361\u6309\u94ae]\r\n        A --\x3e D[GachaFlipAnimation]\r\n    end\r\n    \r\n    subgraph "\u670d\u52a1\u5c42"\r\n        E[GachaPoolService] --\x3e F[\u5361\u6c60\u914d\u7f6e]\r\n        E --\x3e G[\u670d\u52a1\u5668\u540c\u6b65]\r\n        E --\x3e H[\u7f13\u5b58\u7ba1\u7406]\r\n    end\r\n    \r\n    subgraph "\u7f51\u7edc\u5c42"\r\n        I[MessageHub] --\x3e J[gachapool/gacha_draw]\r\n        I --\x3e K[gachapool/get_gacha_pool_info]\r\n    end\r\n    \r\n    A --\x3e E\r\n    E --\x3e I\n'})}),"\n",(0,i.jsx)(r.h2,{id:"\u6838\u5fc3\u7ec4\u4ef6",children:"\u6838\u5fc3\u7ec4\u4ef6"}),"\n",(0,i.jsx)(r.h3,{id:"gachapanelcontroller---\u4e3b\u63a7\u5236\u5668",children:"GachaPanelController - \u4e3b\u63a7\u5236\u5668"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-csharp",children:'[RequireComponent(typeof(UIDocument))]\r\npublic class GachaPanelController : MonoBehaviour\r\n{\r\n    // \u6a21\u677f\u548c\u5f15\u7528\r\n    [SerializeField] private VisualTreeAsset poolTemplate;\r\n    [SerializeField] private CardSystemConfig config;\r\n    [SerializeField] private GachaFlipAnimationController flipAnimationController;\r\n    \r\n    // \u670d\u52a1\r\n    private GachaPoolService poolService;\r\n    const string kDrawMethod = "gachapool/gacha_draw";\r\n    \r\n    // UI\u5143\u7d20\r\n    ScrollViewPro scroll;\r\n    VisualElement listRoot, selectedItem;\r\n    Button oneBtn, tenBtn, returnBtn;\r\n    Label ticketLbl;\r\n    \r\n    // \u8fd0\u884c\u65f6\u72b6\u6001\r\n    Action<ResourceType,long> bankHandler;\r\n}\n'})}),"\n",(0,i.jsx)(r.h3,{id:"gachapoolservice---\u5361\u6c60\u670d\u52a1",children:"GachaPoolService - \u5361\u6c60\u670d\u52a1"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-csharp",children:'public class GachaPoolService : MonoBehaviour\r\n{\r\n    public static GachaPoolService I { get; private set; }\r\n    \r\n    // \u5361\u6c60\u6570\u636e\r\n    readonly List<GachaPoolInfo> _pools = new();\r\n    public List<GachaPoolInfo> Pools => _pools;\r\n    \r\n    // \u4e8b\u4ef6\r\n    public event Action<List<GachaPoolInfo>> OnPoolListReady;\r\n    \r\n    // \u72b6\u6001\r\n    public bool IsInited { get; private set; }\r\n    public static long ServerDeltaSec = 0;\r\n    \r\n    // \u7f13\u5b58\r\n    const string CacheFile = "gacha_pools.json";\r\n    \r\n    // \u65b9\u6cd5\r\n    public void Init();\r\n    void LoadCache();\r\n    void SaveCache(string json);\r\n    void DownloadAllBanners(IEnumerable<GachaPoolInfo> pools);\r\n}\n'})}),"\n",(0,i.jsx)(r.h2,{id:"\u6570\u636e\u6a21\u578b",children:"\u6570\u636e\u6a21\u578b"}),"\n",(0,i.jsx)(r.h3,{id:"gachapoolinfo---\u5361\u6c60\u4fe1\u606f",children:"GachaPoolInfo - \u5361\u6c60\u4fe1\u606f"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-csharp",children:"[Serializable]\r\npublic class GachaPoolInfo\r\n{\r\n    public int id;              // \u5361\u6c60ID\r\n    public string title;        // \u5361\u6c60\u540d\u79f0\r\n    public int costx1;          // \u5355\u62bd\u6d88\u8017\r\n    public int costx10;         // \u5341\u8fde\u6d88\u8017\r\n    \r\n    // \u5012\u8ba1\u65f6\r\n    public bool showCountdown;  // \u662f\u5426\u663e\u793a\u5012\u8ba1\u65f6\r\n    public long endUtcSeconds;  // \u7ed3\u675f\u65f6\u95f4\uff08UTC\u79d2\uff09\r\n    \r\n    // Banner\u56fe\u7247\r\n    public Sprite banner;        // UI\u4f7f\u7528\u7684\u56fe\u7247\r\n    public string poolImageUrl;  // \u670d\u52a1\u5668\u56fe\u7247URL\r\n}\n"})}),"\n",(0,i.jsx)(r.h3,{id:"\u7f51\u7edc\u534f\u8bae",children:"\u7f51\u7edc\u534f\u8bae"}),"\n",(0,i.jsx)(r.h4,{id:"\u62bd\u5361\u8bf7\u6c42",children:"\u62bd\u5361\u8bf7\u6c42"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-csharp",children:"[Serializable]\r\nprivate struct DrawInput \r\n{ \r\n    public int pool_id;    // \u5361\u6c60ID\r\n    public int amount;     // \u62bd\u5361\u6570\u91cf\uff081\u621610\uff09\r\n}\n"})}),"\n",(0,i.jsx)(r.h4,{id:"\u62bd\u5361\u54cd\u5e94",children:"\u62bd\u5361\u54cd\u5e94"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-json",children:'{\r\n    "consumption_current_balance": {\r\n        "SummonWrit": 1800  // \u6d88\u8017\u7684\u5f81\u624d\u4ee4\r\n    },\r\n    "gain_current_balance": {\r\n        "Card_S1": "unlocked",           // \u65b0\u89e3\u9501\u7684\u5361\u724c\r\n        "HeroCrest_S2": 200,            // \u83b7\u5f97\u7684\u788e\u7247\r\n        "Gift_wine": 5                  // \u83b7\u5f97\u7684\u793c\u7269\r\n    },\r\n    "draw_details": [\r\n        "Card_S1",      // \u62bd\u5230\u7684\u7269\u54c1\u5217\u8868\r\n        "Card_S2",\r\n        "Card_S2",      // \u91cd\u590d\u5361\u724c\u4f1a\u8f6c\u6362\u4e3a\u788e\u7247\r\n        "Gift_wine",\r\n        "Gift_silk"\r\n    ]\r\n}\n'})}),"\n",(0,i.jsx)(r.h2,{id:"\u62bd\u5361\u6d41\u7a0b",children:"\u62bd\u5361\u6d41\u7a0b"}),"\n",(0,i.jsx)(r.h3,{id:"1-\u9009\u62e9\u5361\u6c60",children:"1. \u9009\u62e9\u5361\u6c60"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-csharp",children:'void SelectPool(VisualElement item)\r\n{\r\n    if (selectedItem == item) return;\r\n    \r\n    // \u66f4\u65b0\u9009\u4e2d\u72b6\u6001\r\n    selectedItem?.RemoveFromClassList("selected");\r\n    selectedItem = item;\r\n    selectedItem.AddToClassList("selected");\r\n    \r\n    // \u66f4\u65b0\u5176\u4ed6\u5361\u6c60\u7684\u906e\u7f69\r\n    foreach (var child in listRoot.Children())\r\n    {\r\n        child.Q<VisualElement>("BlackDim")\r\n             ?.SetDisplay(child == item ? DisplayStyle.None : DisplayStyle.Flex);\r\n    }\r\n    \r\n    // \u66f4\u65b0\u6309\u94ae\u663e\u793a\r\n    if (item.userData is GachaPoolInfo g)\r\n    {\r\n        oneBtn.text = $"1x ({g.costx1})";\r\n        tenBtn.text = $"10x ({g.costx10})";\r\n    }\r\n    \r\n    scroll.ScrollTo(item);\r\n}\n'})}),"\n",(0,i.jsx)(r.h3,{id:"2-\u68c0\u67e5\u8d44\u6e90",children:"2. \u68c0\u67e5\u8d44\u6e90"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-csharp",children:'void Roll(int count)\r\n{\r\n    if (selectedItem?.userData is not GachaPoolInfo info) return;\r\n    \r\n    // \u8ba1\u7b97\u6d88\u8017\r\n    int cost = (count == 1) ? info.costx1 : info.costx10;\r\n    \r\n    // \u68c0\u67e5\u5f81\u624d\u4ee4\r\n    if (PlayerResourceBank.I[ResourceType.SummonWrit] < cost)\r\n    {\r\n        PopupManager.Show("\u62bd\u5956\u5931\u8d25", $"\u5f81\u624d\u4ee4\u4e0d\u591f\uff01\u9700\u8981 {cost} \u4e2a\u5f81\u624d\u4ee4\u3002");\r\n        return;\r\n    }\r\n    \r\n    // \u53d1\u9001\u8bf7\u6c42\r\n    var input = new DrawInput { pool_id = info.id, amount = count };\r\n    MessageHub.I.Request(kDrawMethod, input, OnDrawResp, 10f);\r\n}\n'})}),"\n",(0,i.jsx)(r.h3,{id:"3-\u5904\u7406\u62bd\u5361\u7ed3\u679c",children:"3. \u5904\u7406\u62bd\u5361\u7ed3\u679c"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-csharp",children:'void OnDrawResp(MessageHub.Response resp)\r\n{\r\n    if (resp == null || resp.code != 0)\r\n    {\r\n        PopupManager.Show("\u62bd\u5956\u5931\u8d25", resp?.msg ?? "\u7f51\u7edc\u9519\u8bef");\r\n        return;\r\n    }\r\n    \r\n    try\r\n    {\r\n        var jsonObj = JObject.Parse(resp.dataJson);\r\n        \r\n        // 1. \u5904\u7406\u6d88\u8017\u7684\u8d44\u6e90\r\n        var consumption = jsonObj["consumption_current_balance"]?.ToObject<Dictionary<string, long>>();\r\n        if (consumption != null)\r\n        {\r\n            ApplyConsumption(consumption);\r\n        }\r\n        \r\n        // 2. \u5904\u7406\u83b7\u5f97\u7684\u7269\u54c1\r\n        var gains = jsonObj["gain_current_balance"] as JObject;\r\n        if (gains != null)\r\n        {\r\n            ApplyGains(gains);\r\n        }\r\n        \r\n        // 3. \u663e\u793a\u62bd\u5956\u52a8\u753b\r\n        var drawDetails = jsonObj["draw_details"]?.ToObject<List<string>>();\r\n        if (drawDetails != null && drawDetails.Count > 0)\r\n        {\r\n            if (flipAnimationController != null)\r\n            {\r\n                // \u663e\u793a\u7ffb\u5361\u52a8\u753b\r\n                flipAnimationController.ShowGachaAnimation(\r\n                    drawDetails,\r\n                    () => { /* \u52a8\u753b\u7ed3\u675f\u56de\u8c03 */ },\r\n                    () => { Roll(10); }  // \u518d\u62bd10\u6b21\u56de\u8c03\r\n                );\r\n            }\r\n        }\r\n    }\r\n    catch (Exception e)\r\n    {\r\n        Debug.LogError($"[OnDrawResp] Exception: {e}");\r\n        PopupManager.Show("\u62bd\u5956\u5931\u8d25", "\u6570\u636e\u5904\u7406\u5f02\u5e38");\r\n    }\r\n}\n'})}),"\n",(0,i.jsx)(r.h2,{id:"\u5956\u52b1\u5904\u7406",children:"\u5956\u52b1\u5904\u7406"}),"\n",(0,i.jsx)(r.h3,{id:"1-\u65b0\u5361\u4e0e\u788e\u7247\u8f6c\u6362",children:"1. \u65b0\u5361\u4e0e\u788e\u7247\u8f6c\u6362"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-csharp",children:'void ApplyGains(JObject gains)\r\n{\r\n    foreach (var property in gains.Properties())\r\n    {\r\n        string itemId = property.Name;\r\n        JToken value = property.Value;\r\n        \r\n        // 1. \u5904\u7406\u5361\u724c\r\n        if (itemId.StartsWith("Card_"))\r\n        {\r\n            string cardId = itemId.Substring(5);  // \u79fb\u9664 "Card_" \u524d\u7f00\r\n            \r\n            if (value.ToString() == "unlocked")\r\n            {\r\n                // \u65b0\u89e3\u9501\u7684\u5361\u724c\r\n                HandleNewCard(cardId);\r\n            }\r\n            else if (value.Type == JTokenType.Integer)\r\n            {\r\n                // \u8f6c\u6362\u4e3a\u788e\u7247\uff08\u91cd\u590d\u5361\u724c\uff09\r\n                int shardCount = value.ToObject<int>();\r\n                HandleCardShards(cardId, shardCount);\r\n            }\r\n        }\r\n        // 2. \u5904\u7406\u788e\u7247\r\n        else if (itemId.StartsWith("HeroCrest_"))\r\n        {\r\n            int count = value.ToObject<int>();\r\n            UpdateShardInventory(itemId, count);\r\n        }\r\n        // 3. \u5904\u7406\u5176\u4ed6\u7269\u54c1\r\n        else\r\n        {\r\n            HandleOtherItems(itemId, value);\r\n        }\r\n    }\r\n}\n'})}),"\n",(0,i.jsx)(r.h3,{id:"2-\u5361\u724c\u89e3\u9501\u5904\u7406",children:"2. \u5361\u724c\u89e3\u9501\u5904\u7406"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-csharp",children:'void HandleNewCard(string cardId)\r\n{\r\n    // \u68c0\u67e5\u662f\u5426\u5df2\u62e5\u6709\r\n    var existingCard = PlayerCardBank.I.Get(cardId);\r\n    \r\n    if (existingCard == null)\r\n    {\r\n        // \u6dfb\u52a0\u65b0\u5361\r\n        var newCard = new PlayerCard\r\n        {\r\n            id = cardId,\r\n            level = 1,\r\n            star = 0,  // \u521d\u59cb0\u661f\r\n            isPhantom = false\r\n        };\r\n        \r\n        PlayerCardBank.I.AddCard(newCard);\r\n        PlayerCardBankMgr.I?.onCardChanged?.Invoke(cardId);\r\n        \r\n        Debug.Log($"[Gacha] \u65b0\u5361\u89e3\u9501: {cardId}");\r\n    }\r\n    else\r\n    {\r\n        // \u5df2\u62e5\u6709\uff0c\u8f6c\u6362\u4e3a\u788e\u7247\r\n        Debug.Log($"[Gacha] \u5361\u724c {cardId} \u5df2\u62e5\u6709\uff0c\u8f6c\u6362\u4e3a\u788e\u7247");\r\n    }\r\n}\n'})}),"\n",(0,i.jsx)(r.h2,{id:"\u7ffb\u5361\u52a8\u753b",children:"\u7ffb\u5361\u52a8\u753b"}),"\n",(0,i.jsx)(r.h3,{id:"gachaflipanimationcontroller",children:"GachaFlipAnimationController"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-csharp",children:"public class GachaFlipAnimationController : MonoBehaviour\r\n{\r\n    [SerializeField] private float cardFlipDelay = 0.15f;\r\n    [SerializeField] private float cardFlipDuration = 0.6f;\r\n    [SerializeField] private float glowFadeDuration = 1.0f;\r\n    \r\n    // \u663e\u793a\u62bd\u5361\u52a8\u753b\r\n    public void ShowGachaAnimation(\r\n        List<string> items,\r\n        Action onConfirm,\r\n        Action onDrawAgain)\r\n    {\r\n        // \u521b\u5efa\u5361\u7247UI\r\n        CreateCardGrid(items);\r\n        \r\n        // \u64ad\u653e\u7ffb\u5361\u52a8\u753b\r\n        StartCoroutine(PlayFlipAnimation(items));\r\n        \r\n        // \u8bbe\u7f6e\u6309\u94ae\u56de\u8c03\r\n        SetupButtons(onConfirm, onDrawAgain);\r\n    }\r\n    \r\n    // \u7ffb\u5361\u52a8\u753b\u534f\u7a0b\r\n    IEnumerator PlayFlipAnimation(List<string> items)\r\n    {\r\n        for (int i = 0; i < items.Count; i++)\r\n        {\r\n            // \u5ef6\u8fdf\u7ffb\u5f00\u6bcf\u5f20\u5361\r\n            yield return new WaitForSeconds(cardFlipDelay);\r\n            \r\n            // \u64ad\u653e\u7ffb\u8f6c\u52a8\u753b\r\n            FlipCard(i);\r\n            \r\n            // \u64ad\u653e\u97f3\u6548\r\n            PlayCardFlipSound();\r\n            \r\n            // \u663e\u793a\u5149\u6548\uff08\u6839\u636e\u7a00\u6709\u5ea6\uff09\r\n            ShowCardGlow(i, GetItemRarity(items[i]));\r\n        }\r\n        \r\n        // \u663e\u793a\u786e\u8ba4\u6309\u94ae\r\n        ShowConfirmButtons();\r\n    }\r\n}\n"})}),"\n",(0,i.jsx)(r.h2,{id:"\u5361\u6c60\u7ba1\u7406",children:"\u5361\u6c60\u7ba1\u7406"}),"\n",(0,i.jsx)(r.h3,{id:"1-\u5361\u6c60\u5217\u8868\u6784\u5efa",children:"1. \u5361\u6c60\u5217\u8868\u6784\u5efa"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-csharp",children:'void BuildPoolList(List<GachaPoolInfo> pools)\r\n{\r\n    listRoot.Clear();\r\n    const float poolW = 500f, poolH = 420f, gap = 32f;\r\n    \r\n    foreach (var info in pools)\r\n    {\r\n        // \u521b\u5efa\u5361\u6c60\u5bb9\u5668\r\n        var container = poolTemplate.Instantiate();\r\n        container.userData = info;\r\n        \r\n        // \u8bbe\u7f6e\u5c3a\u5bf8\r\n        container.style.width = poolW;\r\n        container.style.height = poolH;\r\n        container.style.flexBasis = poolW;\r\n        container.style.flexShrink = 0;\r\n        container.style.marginRight = gap;\r\n        \r\n        // \u8bbe\u7f6e\u6807\u9898\r\n        var titleLbl = container.Q<Label>("PoolTitle");\r\n        if (titleLbl != null) titleLbl.text = info.title;\r\n        \r\n        // \u8bbe\u7f6eBanner\u56fe\r\n        var poolBtn = container.Q<Button>("PoolBtn");\r\n        if (poolBtn != null && info.banner != null)\r\n            poolBtn.style.backgroundImage = new StyleBackground(info.banner);\r\n        \r\n        // \u6dfb\u52a0\u70b9\u51fb\u4e8b\u4ef6\r\n        (poolBtn ?? container)\r\n            .RegisterCallback<ClickEvent>(_ => SelectPool(container));\r\n        \r\n        // \u6dfb\u52a0\u5012\u8ba1\u65f6\uff08\u5982\u679c\u6709\uff09\r\n        AttachCountdown(container, info.showCountdown, info.endUtcSeconds);\r\n        \r\n        listRoot.Add(container);\r\n    }\r\n    \r\n    scroll.RefreshAfterHierarchyChange();\r\n}\n'})}),"\n",(0,i.jsx)(r.h3,{id:"2-\u9650\u65f6\u6d3b\u52a8\u5012\u8ba1\u65f6",children:"2. \u9650\u65f6\u6d3b\u52a8\u5012\u8ba1\u65f6"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-csharp",children:'void AttachCountdown(VisualElement container, bool enable, long endUtcSeconds)\r\n{\r\n    var label = container.Q<Label>("RemainLbl");\r\n    if (label == null) return;\r\n    \r\n    if (!enable || endUtcSeconds <= 0)\r\n    {\r\n        label.style.display = DisplayStyle.None;\r\n        return;\r\n    }\r\n    \r\n    void Refresh()\r\n    {\r\n        long now = DateTimeOffset.UtcNow.ToUnixTimeSeconds() \r\n                 + GachaPoolService.ServerDeltaSec;\r\n        long diff = endUtcSeconds - now;\r\n        \r\n        if (diff <= 0)\r\n        {\r\n            label.text = "\u5df2\u7ed3\u675f";\r\n            return;\r\n        }\r\n        \r\n        var left = TimeSpan.FromSeconds(diff);\r\n        label.text = $"\u5269\u4f59 {left:dd\\\\\u5929hh\\\\:mm\\\\:ss}";\r\n        label.schedule.Execute(Refresh).ExecuteLater(1000);\r\n    }\r\n    \r\n    Refresh();\r\n}\n'})}),"\n",(0,i.jsx)(r.h2,{id:"\u7f13\u5b58\u673a\u5236",children:"\u7f13\u5b58\u673a\u5236"}),"\n",(0,i.jsx)(r.h3,{id:"\u5361\u6c60\u4fe1\u606f\u7f13\u5b58",children:"\u5361\u6c60\u4fe1\u606f\u7f13\u5b58"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-csharp",children:"// GachaPoolService.cs\r\nvoid LoadCache()\r\n{\r\n    string path = Path.Combine(Application.persistentDataPath, CacheFile);\r\n    if (!File.Exists(path)) return;\r\n    \r\n    var list = ParseRemotePools(File.ReadAllText(path));\r\n    if (list?.Count > 0)\r\n    {\r\n        _pools.AddRange(list);\r\n        DownloadAllBanners(_pools);\r\n    }\r\n}\r\n\r\nvoid SaveCache(string json)\r\n{\r\n    string path = Path.Combine(Application.persistentDataPath, CacheFile);\r\n    File.WriteAllText(path, json);\r\n}\n"})}),"\n",(0,i.jsx)(r.h3,{id:"banner\u56fe\u7247\u4e0b\u8f7d",children:"Banner\u56fe\u7247\u4e0b\u8f7d"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-csharp",children:"void DownloadAllBanners(IEnumerable<GachaPoolInfo> pools)\r\n{\r\n    foreach (var g in pools)\r\n    {\r\n        if (string.IsNullOrEmpty(g.poolImageUrl)) continue;\r\n        if (g.banner != null) continue;  // \u5df2\u6709\u672c\u5730Sprite\r\n        \r\n        BannerCache.I.GetSprite(g.poolImageUrl, sp => \r\n        {\r\n            if (sp != null) g.banner = sp;\r\n        });\r\n    }\r\n}\n"})}),"\n",(0,i.jsx)(r.h2,{id:"\u6d4b\u8bd5\u5de5\u5177",children:"\u6d4b\u8bd5\u5de5\u5177"}),"\n",(0,i.jsx)(r.h3,{id:"\u83b7\u53d6\u6d4b\u8bd5\u8d44\u6e90",children:"\u83b7\u53d6\u6d4b\u8bd5\u8d44\u6e90"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-csharp",children:'// \u6d4b\u8bd5\u6309\u94ae\uff1a\u83b7\u53d6\u62bd\u5361\u8d44\u6e90\r\nvoid OnTestButtonClicked()\r\n{\r\n    var req = new GetItemInput\r\n    {\r\n        all = 0,\r\n        item_id = new List<string> \r\n        { \r\n            "SummonWrit",           // \u5f81\u624d\u4ee4\uff08\u62bd\u5361\u5238\uff09\r\n            "HeroCrest_SGeneral",   // S\u7ea7\u901a\u7528\u788e\u7247\r\n            "HeroCrest_AGeneral",   // A\u7ea7\u901a\u7528\u788e\u7247\r\n            "HeroCrest_BGeneral",   // B\u7ea7\u901a\u7528\u788e\u7247\r\n            "Gift_wine",            // \u793c\u7269\r\n            "Gift_silk"\r\n        },\r\n        amount = 10000\r\n    };\r\n    \r\n    MessageHub.I.Request("test/GetItem", req, OnGetItemResp, 8f);\r\n}\n'})}),"\n",(0,i.jsx)(r.h2,{id:"\u667a\u80fd\u7ed3\u679c\u663e\u793a",children:"\u667a\u80fd\u7ed3\u679c\u663e\u793a"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-csharp",children:'void ShowDrawResultSmart(List<string> drawDetails, JObject gains)\r\n{\r\n    var lines = new List<string>();\r\n    \r\n    // \u7edf\u8ba1\u62bd\u5230\u7684\u5361\u7247\r\n    var cardCount = new Dictionary<string, int>();\r\n    foreach (var item in drawDetails)\r\n    {\r\n        if (item.StartsWith("Card_"))\r\n        {\r\n            cardCount[item] = cardCount.ContainsKey(item) ? cardCount[item] + 1 : 1;\r\n        }\r\n    }\r\n    \r\n    // \u5206\u6790\u6bcf\u79cd\u5361\u7247\r\n    foreach (var kv in cardCount)\r\n    {\r\n        string cardId = kv.Key.Substring(5);\r\n        int totalCount = kv.Value;\r\n        \r\n        var cardInfo = GetCardInfo(cardId);\r\n        if (cardInfo == null) continue;\r\n        \r\n        string tierTag = GetTierTag(cardInfo.tier);\r\n        string cardName = cardInfo.displayName;\r\n        \r\n        // \u68c0\u67e5\u662f\u5426\u6709\u65b0\u5361\u89e3\u9501\r\n        bool hasNewCard = gains?[kv.Key]?.ToString() == "unlocked";\r\n        \r\n        if (hasNewCard)\r\n        {\r\n            lines.Add($"{tierTag} {cardName}");\r\n            \r\n            // \u591a\u4f59\u7684\u8f6c\u4e3a\u788e\u7247\r\n            if (totalCount > 1)\r\n            {\r\n                int shardsCount = (totalCount - 1) * 100;\r\n                lines.Add($"{tierTag} {cardName}\u788e\u7247 x{shardsCount}");\r\n            }\r\n        }\r\n        else\r\n        {\r\n            // \u5168\u90e8\u8f6c\u4e3a\u788e\u7247\r\n            int shardsCount = totalCount * 100;\r\n            lines.Add($"{tierTag} {cardName}\u788e\u7247 x{shardsCount}");\r\n        }\r\n    }\r\n    \r\n    string message = lines.Count > 0 ? string.Join("\\n", lines) : "\u6ca1\u6709\u83b7\u5f97\u4efb\u4f55\u7269\u54c1";\r\n    PopupManager.Show("\u62bd\u5956\u7ed3\u679c", message);\r\n}\n'})}),"\n",(0,i.jsx)(r.h2,{id:"\u7279\u6b8a\u89c4\u5219",children:"\u7279\u6b8a\u89c4\u5219"}),"\n",(0,i.jsx)(r.h3,{id:"1-\u91cd\u590d\u5361\u724c\u8f6c\u6362",children:"1. \u91cd\u590d\u5361\u724c\u8f6c\u6362"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"\u7b2c\u4e00\u6b21\u83b7\u5f97\uff1a\u89e3\u9501\u65b0\u5361"}),"\n",(0,i.jsx)(r.li,{children:"\u91cd\u590d\u83b7\u5f97\uff1a\u81ea\u52a8\u8f6c\u6362\u4e3a100\u4e2a\u788e\u7247"}),"\n",(0,i.jsx)(r.li,{children:"\u788e\u7247\u7528\u4e8e\u5361\u724c\u5347\u661f"}),"\n"]}),"\n",(0,i.jsx)(r.h3,{id:"2-\u4fdd\u5e95\u673a\u5236",children:"2. \u4fdd\u5e95\u673a\u5236"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"\u670d\u52a1\u5668\u63a7\u5236\u6982\u7387"}),"\n",(0,i.jsx)(r.li,{children:"\u5341\u8fde\u62bd\u901a\u5e38\u6709\u4fdd\u5e95\uff08\u81f3\u5c11\u4e00\u4e2a\u9ad8\u54c1\u8d28\uff09"}),"\n",(0,i.jsx)(r.li,{children:"\u7d2f\u8ba1\u62bd\u5361\u6b21\u6570\u4fdd\u5e95\uff08\u670d\u52a1\u5668\u8bb0\u5f55\uff09"}),"\n"]}),"\n",(0,i.jsx)(r.h3,{id:"3-\u6d88\u8017\u4e0e\u6298\u6263",children:"3. \u6d88\u8017\u4e0e\u6298\u6263"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-csharp",children:"// \u5341\u8fde\u62bd\u6298\u6263\r\n\u5355\u62bd\u6d88\u8017\uff1a200\u5f81\u624d\u4ee4\r\n\u5341\u8fde\u6d88\u8017\uff1a1800\u5f81\u624d\u4ee4\uff089\u6298\uff09\n"})}),"\n",(0,i.jsx)(r.h3,{id:"4-\u5361\u6c60\u7c7b\u578b",children:"4. \u5361\u6c60\u7c7b\u578b"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"\u5e38\u9a7b\u5361\u6c60"}),"\uff1a\u6c38\u4e45\u5f00\u653e"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"\u9650\u65f6\u5361\u6c60"}),"\uff1a\u6709\u5012\u8ba1\u65f6\uff0c\u5230\u671f\u5173\u95ed"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"\u65b0\u624b\u5361\u6c60"}),"\uff1a\u7279\u6b8a\u4f18\u60e0\uff0c\u9650\u5b9a\u6b21\u6570"]}),"\n"]}),"\n",(0,i.jsx)(r.h2,{id:"\u6ce8\u610f\u4e8b\u9879",children:"\u6ce8\u610f\u4e8b\u9879"}),"\n",(0,i.jsxs)(r.ol,{children:["\n",(0,i.jsxs)(r.li,{children:["\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.strong,{children:"\u7f51\u7edc\u540c\u6b65"})}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"\u6240\u6709\u62bd\u5361\u5fc5\u987b\u901a\u8fc7\u670d\u52a1\u5668"}),"\n",(0,i.jsx)(r.li,{children:"\u672c\u5730\u4e0d\u5b58\u50a8\u6982\u7387\u914d\u7f6e"}),"\n",(0,i.jsx)(r.li,{children:"\u7ed3\u679c\u7531\u670d\u52a1\u5668\u51b3\u5b9a"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(r.li,{children:["\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.strong,{children:"\u52a8\u753b\u4f18\u5316"})}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"\u7ffb\u5361\u52a8\u753b\u53ef\u8df3\u8fc7"}),"\n",(0,i.jsx)(r.li,{children:"\u5341\u8fde\u62bd\u6279\u91cf\u663e\u793a"}),"\n",(0,i.jsx)(r.li,{children:"\u9884\u52a0\u8f7d\u5361\u7247\u8d44\u6e90"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(r.li,{children:["\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.strong,{children:"\u9519\u8bef\u5904\u7406"})}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"\u7f51\u7edc\u5931\u8d25\u91cd\u8bd5\u673a\u5236"}),"\n",(0,i.jsx)(r.li,{children:"\u8d44\u6e90\u4e0d\u8db3\u63d0\u793a"}),"\n",(0,i.jsx)(r.li,{children:"\u670d\u52a1\u5668\u9519\u8bef\u7801\u5904\u7406"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(r.li,{children:["\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.strong,{children:"\u6027\u80fd\u4f18\u5316"})}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"\u5361\u6c60\u4fe1\u606f\u7f13\u5b58"}),"\n",(0,i.jsx)(r.li,{children:"Banner\u56fe\u5f02\u6b65\u4e0b\u8f7d"}),"\n",(0,i.jsx)(r.li,{children:"\u865a\u62df\u5316\u5361\u6c60\u5217\u8868"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(r.li,{children:["\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.strong,{children:"UI\u9002\u914d"})}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"\u6a2a\u5411\u6eda\u52a8\u5361\u6c60\u5217\u8868"}),"\n",(0,i.jsx)(r.li,{children:"\u54cd\u5e94\u5f0f\u5e03\u5c40"}),"\n",(0,i.jsx)(r.li,{children:"\u79fb\u52a8\u7aef\u624b\u52bf\u652f\u6301"}),"\n"]}),"\n"]}),"\n"]})]})}function h(n={}){const{wrapper:r}={...(0,a.R)(),...n.components};return r?(0,i.jsx)(r,{...n,children:(0,i.jsx)(d,{...n})}):d(n)}},8453:(n,r,e)=>{e.d(r,{R:()=>t,x:()=>o});var l=e(6540);const i={},a=l.createContext(i);function t(n){const r=l.useContext(a);return l.useMemo(function(){return"function"==typeof n?n(r):{...r,...n}},[r,n])}function o(n){let r;return r=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:t(n.components),l.createElement(a.Provider,{value:r},n.children)}}}]);