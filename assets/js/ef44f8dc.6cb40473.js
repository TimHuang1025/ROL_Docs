"use strict";(self.webpackChunkgame_docs=self.webpackChunkgame_docs||[]).push([[139],{6276:(n,r,e)=>{e.r(r),e.d(r,{assets:()=>o,contentTitle:()=>d,default:()=>h,frontMatter:()=>t,metadata:()=>a,toc:()=>c});const a=JSON.parse('{"id":"\u5361\u724c/phantom-card-system","title":"\u5e7b\u5f71\u5361\u7cfb\u7edf","description":"\u7cfb\u7edf\u6982\u8ff0","source":"@site/docs/\u5361\u724c/phantom-card-system.md","sourceDirName":"\u5361\u724c","slug":"/\u5361\u724c/phantom-card-system","permalink":"/ROL_Docs/docs/\u5361\u724c/phantom-card-system","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"id":"phantom-card-system","title":"\u5e7b\u5f71\u5361\u7cfb\u7edf","sidebar_label":"\u5e7b\u5f71\u5361\u7cfb\u7edf","sidebar_position":5},"sidebar":"tutorialSidebar","previous":{"title":"\u5347\u661f\u7cfb\u7edf","permalink":"/ROL_Docs/docs/\u5361\u724c/card-star-system"},"next":{"title":"\u88c5\u5907\u7cfb\u7edf","permalink":"/ROL_Docs/docs/\u5361\u724c/card-equipment-system"}}');var l=e(4848),i=e(8453);const t={id:"phantom-card-system",title:"\u5e7b\u5f71\u5361\u7cfb\u7edf",sidebar_label:"\u5e7b\u5f71\u5361\u7cfb\u7edf",sidebar_position:5},d="\u5e7b\u5f71\u5361\u7cfb\u7edf",o={},c=[{value:"\u7cfb\u7edf\u6982\u8ff0",id:"\u7cfb\u7edf\u6982\u8ff0",level:2},{value:"\u6838\u5fc3\u673a\u5236",id:"\u6838\u5fc3\u673a\u5236",level:2},{value:"\u590d\u5236\u673a\u5236",id:"\u590d\u5236\u673a\u5236",level:3},{value:"\u6570\u636e\u7ed3\u6784",id:"\u6570\u636e\u7ed3\u6784",level:3},{value:"\u5c5e\u6027\u540c\u6b65\u903b\u8f91",id:"\u5c5e\u6027\u540c\u6b65\u903b\u8f91",level:2},{value:"1. \u540c\u6b65\u89c4\u5219",id:"1-\u540c\u6b65\u89c4\u5219",level:3},{value:"2. \u9650\u5236\u6761\u4ef6",id:"2-\u9650\u5236\u6761\u4ef6",level:3},{value:"PhantomClonePanel UI\u5b9e\u73b0",id:"phantomclonepanel-ui\u5b9e\u73b0",level:2},{value:"UI\u7ed3\u6784",id:"ui\u7ed3\u6784",level:3},{value:"PhantomClonePanel \u63a7\u5236\u5668",id:"phantomclonepanel-\u63a7\u5236\u5668",level:3},{value:"\u5361\u724c\u5217\u8868\u6784\u5efa",id:"\u5361\u724c\u5217\u8868\u6784\u5efa",level:3},{value:"\u590d\u5236\u76ee\u6807\u5207\u6362",id:"\u590d\u5236\u76ee\u6807\u5207\u6362",level:2},{value:"1. \u7b80\u5355\u5207\u6362\uff08\u76ee\u6807\u672a\u88ab\u5360\u7528\uff09",id:"1-\u7b80\u5355\u5207\u6362\u76ee\u6807\u672a\u88ab\u5360\u7528",level:3},{value:"2. \u5360\u7528\u51b2\u7a81\u5904\u7406",id:"2-\u5360\u7528\u51b2\u7a81\u5904\u7406",level:3},{value:"3. \u4e24\u6b65\u5207\u6362\u6d41\u7a0b",id:"3-\u4e24\u6b65\u5207\u6362\u6d41\u7a0b",level:3},{value:"\u7f51\u7edc\u534f\u8bae",id:"\u7f51\u7edc\u534f\u8bae",level:2},{value:"\u8bf7\u6c42\u7ed3\u6784",id:"\u8bf7\u6c42\u7ed3\u6784",level:3},{value:"\u54cd\u5e94\u7ed3\u6784",id:"\u54cd\u5e94\u7ed3\u6784",level:3},{value:"\u8fc7\u671f\u65f6\u95f4\u5904\u7406",id:"\u8fc7\u671f\u65f6\u95f4\u5904\u7406",level:2},{value:"\u8fc7\u671f\u68c0\u67e5",id:"\u8fc7\u671f\u68c0\u67e5",level:3},{value:"\u5269\u4f59\u65f6\u95f4\u663e\u793a",id:"\u5269\u4f59\u65f6\u95f4\u663e\u793a",level:3},{value:"UI\u6837\u5f0f",id:"ui\u6837\u5f0f",level:2},{value:"\u9009\u4e2d\u9ad8\u4eae",id:"\u9009\u4e2d\u9ad8\u4eae",level:3},{value:"\u88ab\u5360\u7528\u6837\u5f0f",id:"\u88ab\u5360\u7528\u6837\u5f0f",level:3},{value:"\u4e8b\u4ef6\u901a\u77e5",id:"\u4e8b\u4ef6\u901a\u77e5",level:2},{value:"\u66f4\u65b0\u901a\u77e5\u94fe",id:"\u66f4\u65b0\u901a\u77e5\u94fe",level:3},{value:"\u7279\u6b8a\u89c4\u5219",id:"\u7279\u6b8a\u89c4\u5219",level:2},{value:"1. \u4e3b\u516c\u5361\u4e0d\u80fd\u88ab\u590d\u5236",id:"1-\u4e3b\u516c\u5361\u4e0d\u80fd\u88ab\u590d\u5236",level:3},{value:"2. \u5e7b\u5f71\u5361\u4e0d\u80fd\u590d\u5236\u5e7b\u5f71\u5361",id:"2-\u5e7b\u5f71\u5361\u4e0d\u80fd\u590d\u5236\u5e7b\u5f71\u5361",level:3},{value:"3. \u4e00\u5bf9\u4e00\u5360\u7528\u5173\u7cfb",id:"3-\u4e00\u5bf9\u4e00\u5360\u7528\u5173\u7cfb",level:3},{value:"4. \u6570\u636e\u540c\u6b65\u65f6\u673a",id:"4-\u6570\u636e\u540c\u6b65\u65f6\u673a",level:3},{value:"\u6ce8\u610f\u4e8b\u9879",id:"\u6ce8\u610f\u4e8b\u9879",level:2}];function s(n){const r={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...n.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(r.header,{children:(0,l.jsx)(r.h1,{id:"\u5e7b\u5f71\u5361\u7cfb\u7edf",children:"\u5e7b\u5f71\u5361\u7cfb\u7edf"})}),"\n",(0,l.jsx)(r.h2,{id:"\u7cfb\u7edf\u6982\u8ff0",children:"\u7cfb\u7edf\u6982\u8ff0"}),"\n",(0,l.jsx)(r.p,{children:"\u5e7b\u5f71\u5361\u662f\u4e00\u79cd\u7279\u6b8a\u7684\u5361\u724c\u7c7b\u578b\uff0c\u80fd\u591f\u590d\u5236\u5176\u4ed6\u5df2\u62e5\u6709\u5361\u724c\u7684\u5c5e\u6027\u3002\u5e7b\u5f71\u5361\u4e0d\u80fd\u72ec\u7acb\u5347\u7ea7\uff0c\u5176\u7b49\u7ea7\u3001\u661f\u7ea7\u3001\u5c01\u8d4f\u7b49\u7ea7\u5b8c\u5168\u8ddf\u968f\u590d\u5236\u76ee\u6807\u540c\u6b65\u3002\u7cfb\u7edf\u652f\u6301\u5207\u6362\u590d\u5236\u76ee\u6807\u3001\u5904\u7406\u5360\u7528\u51b2\u7a81\uff0c\u5e76\u53ef\u8bbe\u7f6e\u8fc7\u671f\u65f6\u95f4\u3002"}),"\n",(0,l.jsx)(r.h2,{id:"\u6838\u5fc3\u673a\u5236",children:"\u6838\u5fc3\u673a\u5236"}),"\n",(0,l.jsx)(r.h3,{id:"\u590d\u5236\u673a\u5236",children:"\u590d\u5236\u673a\u5236"}),"\n",(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{className:"language-mermaid",children:"graph LR\r\n    A[\u5e7b\u5f71\u5361] --\x3e|cloneOn| B[\u76ee\u6807\u5361\u724c]\r\n    B --\x3e|clonedBy| A\r\n    B --\x3e C[\u5c5e\u6027\u540c\u6b65]\r\n    C --\x3e D[\u7b49\u7ea7]\r\n    C --\x3e E[\u661f\u7ea7]\r\n    C --\x3e F[\u5c01\u8d4f\u7b49\u7ea7]\r\n    C --\x3e G[\u6280\u80fd\u7b49\u7ea7]\n"})}),"\n",(0,l.jsx)(r.h3,{id:"\u6570\u636e\u7ed3\u6784",children:"\u6570\u636e\u7ed3\u6784"}),"\n",(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{className:"language-csharp",children:'// PlayerCard.cs\r\npublic class PlayerCard\r\n{\r\n    // \u5e7b\u5f71\u5361\u76f8\u5173\u5b57\u6bb5\r\n    public bool isPhantom = false;     // \u662f\u5426\u4e3a\u5e7b\u5f71\u5361\r\n    public string cloneOn = "";        // \u5e7b\u5f71\u5361\u590d\u5236\u7684\u76ee\u6807\u5361\u724cID\r\n    public string clonedBy = "";       // \u88ab\u54ea\u5f20\u5e7b\u5f71\u5361\u590d\u5236\r\n    public long expireTime = 0;        // \u8fc7\u671f\u65f6\u95f4\u6233\uff08\u6beb\u79d2\uff09\uff0c0\u8868\u793a\u6c38\u4e0d\u8fc7\u671f\r\n    \r\n    // \u5176\u4ed6\u5c5e\u6027\uff08\u4f1a\u4ece\u590d\u5236\u76ee\u6807\u540c\u6b65\uff09\r\n    public int level = 1;              // \u7b49\u7ea7\r\n    public int star = 0;               // \u661f\u7ea7\r\n    public int giftLv = 0;             // \u5c01\u8d4f\u7b49\u7ea7\r\n    public int giftExp = 0;            // \u5c01\u8d4f\u7ecf\u9a8c\r\n}\n'})}),"\n",(0,l.jsx)(r.h2,{id:"\u5c5e\u6027\u540c\u6b65\u903b\u8f91",children:"\u5c5e\u6027\u540c\u6b65\u903b\u8f91"}),"\n",(0,l.jsx)(r.h3,{id:"1-\u540c\u6b65\u89c4\u5219",children:"1. \u540c\u6b65\u89c4\u5219"}),"\n",(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{className:"language-csharp",children:"// PlayerCardBankMgr.cs\r\nvoid SyncPhantomsForCard(string originalCardId)\r\n{\r\n    var originalCard = PlayerCardBank.I.Get(originalCardId);\r\n    if (originalCard == null) return;\r\n    \r\n    // \u627e\u51fa\u6240\u6709\u590d\u5236\u6b64\u5361\u7684\u5e7b\u5f71\u5361\r\n    var phantoms = new List<PlayerCard>();\r\n    foreach (var card in PlayerCardBank.I.cards)\r\n    {\r\n        if (card.isPhantom && card.cloneOn == originalCardId)\r\n        {\r\n            phantoms.Add(card);\r\n        }\r\n    }\r\n    \r\n    // \u540c\u6b65\u7b49\u7ea7\u3001\u661f\u7ea7\u3001\u5c01\u8d4f\u7b49\u7ea7\r\n    foreach (var phantom in phantoms)\r\n    {\r\n        phantom.level = originalCard.level;\r\n        phantom.star = originalCard.star;\r\n        phantom.giftLv = originalCard.giftLv;\r\n        phantom.giftExp = originalCard.giftExp;\r\n        \r\n        NotifyUpdated(phantom.id);\r\n    }\r\n}\n"})}),"\n",(0,l.jsx)(r.h3,{id:"2-\u9650\u5236\u6761\u4ef6",children:"2. \u9650\u5236\u6761\u4ef6"}),"\n",(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{className:"language-csharp",children:'// \u5e7b\u5f71\u5361\u4e0d\u80fd\u72ec\u7acb\u5347\u7ea7\r\nif (pc.isPhantom)\r\n{\r\n    Debug.LogWarning($"Cannot upgrade phantom card {id}");\r\n    return;\r\n}\r\n\r\n// \u5e7b\u5f71\u5361\u4e0d\u80fd\u72ec\u7acb\u5347\u661f\r\nif (pc.isPhantom)\r\n{\r\n    Debug.LogWarning($"Cannot star up phantom card {id}");\r\n    return;\r\n}\r\n\r\n// \u5e7b\u5f71\u5361\u4e0d\u80fd\u63a5\u53d7\u5c01\u8d4f\r\nif (pc.isPhantom)\r\n{\r\n    Debug.LogWarning($"Cannot add gift exp to phantom card {id}");\r\n    return;\r\n}\r\n\r\n// \u5e7b\u5f71\u5361\u4e0d\u80fd\u88c5\u5907\u9053\u5177\r\nif (pc.isPhantom)\r\n{\r\n    Debug.LogWarning($"Cannot equip on phantom card {id}");\r\n    return;\r\n}\n'})}),"\n",(0,l.jsx)(r.h2,{id:"phantomclonepanel-ui\u5b9e\u73b0",children:"PhantomClonePanel UI\u5b9e\u73b0"}),"\n",(0,l.jsx)(r.h3,{id:"ui\u7ed3\u6784",children:"UI\u7ed3\u6784"}),"\n",(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{children:'PhantomClonePanel/\r\n\u251c\u2500\u2500 BlackPanel                    # \u4e3b\u9762\u677f\r\n\u2502   \u251c\u2500\u2500 TitleLabel               # \u6807\u9898\uff1a"\u9009\u62e9XX\u8981\u590d\u5236\u7684\u6b66\u5c06"\r\n\u2502   \u251c\u2500\u2500 CurrentCloneLabel        # \u5f53\u524d\u590d\u5236\u72b6\u6001\r\n\u2502   \u251c\u2500\u2500 CardListScroll           # \u5361\u724c\u5217\u8868\uff08ScrollViewPro\uff09\r\n\u2502   \u2502   \u251c\u2500\u2500 ResetCard           # \u91cd\u7f6e\u5361\u7247\uff08\u53d6\u6d88\u590d\u5236\uff09\r\n\u2502   \u2502   \u2514\u2500\u2500 CardOption[]        # \u53ef\u590d\u5236\u7684\u5361\u724c\u5217\u8868\r\n\u2502   \u251c\u2500\u2500 CancelCloneBtn          # \u53d6\u6d88\u590d\u5236\u6309\u94ae\r\n\u2502   \u251c\u2500\u2500 CloseBtn                # \u5173\u95ed\u6309\u94ae\r\n\u2502   \u2514\u2500\u2500 LoadingOverlay          # \u52a0\u8f7d\u906e\u7f69\r\n\u2514\u2500\u2500 BlackSpace                   # \u70b9\u51fb\u5173\u95ed\u533a\u57df\n'})}),"\n",(0,l.jsx)(r.h3,{id:"phantomclonepanel-\u63a7\u5236\u5668",children:"PhantomClonePanel \u63a7\u5236\u5668"}),"\n",(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{className:"language-csharp",children:"public class PhantomClonePanel : MonoBehaviour, IUIPanelController\r\n{\r\n    // UI\u5143\u7d20\r\n    private ScrollViewPro cardListScroll;\r\n    private Button closeBtn;\r\n    private Button cancelCloneBtn;\r\n    private Label titleLabel;\r\n    private Label currentCloneLabel;\r\n    private VisualElement loadingOverlay;\r\n    \r\n    // \u5361\u7247\u6a21\u677f\r\n    [SerializeField] private VisualTreeAsset cardTemplate;\r\n    \r\n    // \u8fd0\u884c\u65f6\u72b6\u6001\r\n    private Dictionary<string, VisualElement> cardContainers = new();\r\n    private string currentSelectedId = null;\r\n    private bool isCardListBuilt = false;\r\n    private bool isProcessing = false;\r\n    \r\n    // \u6570\u636e\r\n    private CardInfoStatic currentStatic;  // \u5e7b\u5f71\u5361\u7684\u9759\u6001\u4fe1\u606f\r\n    private PlayerCard phantomCard;        // \u5e7b\u5f71\u5361\u52a8\u6001\u6570\u636e\r\n    private Action<string> onCloneSelected;\r\n}\n"})}),"\n",(0,l.jsx)(r.h3,{id:"\u5361\u724c\u5217\u8868\u6784\u5efa",children:"\u5361\u724c\u5217\u8868\u6784\u5efa"}),"\n",(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{className:"language-csharp",children:'void BuildCardList()\r\n{\r\n    cardGrid.Clear();\r\n    cardContainers.Clear();\r\n    \r\n    // 1. \u6dfb\u52a0"\u91cd\u7f6e"\u5361\u7247\uff08\u53d6\u6d88\u590d\u5236\uff09\r\n    var resetCard = CreateResetCard();\r\n    cardGrid.Add(resetCard);\r\n    cardContainers["reset"] = resetCard;\r\n    \r\n    // 2. \u83b7\u53d6\u6240\u6709\u53ef\u590d\u5236\u7684\u5361\u7247\uff08\u975e\u5e7b\u5f71\u5361\uff09\r\n    var allCards = PlayerCardBank.I.All;\r\n    var validTargets = new List<PlayerCard>();\r\n    \r\n    foreach (var card in allCards)\r\n    {\r\n        // \u8df3\u8fc7\u5e7b\u5f71\u5361\u3001\u4e3b\u516c\u5361\r\n        if (card.isPhantom || card.id == "LORD") continue;\r\n        validTargets.Add(card);\r\n    }\r\n    \r\n    // 3. \u6392\u5e8f\uff1a\u672a\u88ab\u5360\u7528\u7684\u4f18\u5148\r\n    validTargets.Sort((a, b) => \r\n    {\r\n        bool aOccupied = !string.IsNullOrEmpty(a.clonedBy) && a.clonedBy != phantomCard.id;\r\n        bool bOccupied = !string.IsNullOrEmpty(b.clonedBy) && b.clonedBy != phantomCard.id;\r\n        \r\n        if (aOccupied && !bOccupied) return 1;\r\n        if (!aOccupied && bOccupied) return -1;\r\n        return string.Compare(a.id, b.id);\r\n    });\r\n    \r\n    // 4. \u521b\u5efa\u5361\u7247UI\r\n    foreach (var card in validTargets)\r\n    {\r\n        var cardItem = CreateCardWithTemplate(card);\r\n        cardGrid.Add(cardItem);\r\n        cardContainers[card.id] = cardItem;\r\n    }\r\n    \r\n    // 5. \u66f4\u65b0\u9009\u4e2d\u72b6\u6001\r\n    if (!string.IsNullOrEmpty(phantomCard.cloneOn))\r\n    {\r\n        UpdateSelectionState();\r\n    }\r\n}\n'})}),"\n",(0,l.jsx)(r.h2,{id:"\u590d\u5236\u76ee\u6807\u5207\u6362",children:"\u590d\u5236\u76ee\u6807\u5207\u6362"}),"\n",(0,l.jsx)(r.h3,{id:"1-\u7b80\u5355\u5207\u6362\u76ee\u6807\u672a\u88ab\u5360\u7528",children:"1. \u7b80\u5355\u5207\u6362\uff08\u76ee\u6807\u672a\u88ab\u5360\u7528\uff09"}),"\n",(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{className:"language-csharp",children:'void SelectCloneTarget(string targetId)\r\n{\r\n    if (string.IsNullOrEmpty(targetId)) return;\r\n    \r\n    // \u53d1\u9001\u8bf7\u6c42\r\n    var req = new PhantomCloneReq\r\n    {\r\n        phantom_card = phantomCard.id,\r\n        unclone = 0,  // 0=\u8bbe\u7f6e\u590d\u5236\uff0c1=\u53d6\u6d88\u590d\u5236\r\n        clone_on = targetId\r\n    };\r\n    \r\n    MessageHub.I.Request("card/phantom_clone", req, OnPhantomCloneResp, 10f);\r\n    ShowLoading(true);\r\n}\n'})}),"\n",(0,l.jsx)(r.h3,{id:"2-\u5360\u7528\u51b2\u7a81\u5904\u7406",children:"2. \u5360\u7528\u51b2\u7a81\u5904\u7406"}),"\n",(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{className:"language-csharp",children:'void HandleOccupiedTarget(PlayerCard targetCard)\r\n{\r\n    string occupyingPhantomId = targetCard.clonedBy;\r\n    \r\n    // \u83b7\u53d6\u663e\u793a\u540d\u79f0\r\n    var targetStatic = CardDatabaseStatic.Instance.Get(targetCard.id);\r\n    var occupyingStatic = CardDatabaseStatic.Instance.Get(occupyingPhantomId);\r\n    \r\n    string message = $"{targetName} \u5df2\u88ab {occupyingName} \u5360\u7528\\n\\n" +\r\n                    $"\u786e\u8ba4\u5c06 {currentPhantomName} \u590d\u5236\u76ee\u6807\u5207\u6362\u4e3a {targetName}\uff1f";\r\n    \r\n    PopupManager.ShowConfirm(\r\n        message,\r\n        onYes: () => {\r\n            PerformSwitch(targetCard.id, occupyingPhantomId);\r\n        },\r\n        onNo: null,\r\n        yesText: "\u786e\u8ba4\u5207\u6362",\r\n        noText: "\u53d6\u6d88"\r\n    );\r\n}\n'})}),"\n",(0,l.jsx)(r.h3,{id:"3-\u4e24\u6b65\u5207\u6362\u6d41\u7a0b",children:"3. \u4e24\u6b65\u5207\u6362\u6d41\u7a0b"}),"\n",(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{className:"language-csharp",children:'IEnumerator PerformSwitchCoroutine(string targetCardId, string occupyingPhantomId)\r\n{\r\n    ShowLoading(true);\r\n    \r\n    // \u6b65\u9aa41\uff1a\u89e3\u9664\u5360\u7528\uff08\u8ba9\u5360\u7528\u7684\u5e7b\u5f71\u5361\u53d6\u6d88\u590d\u5236\uff09\r\n    bool step1Success = false;\r\n    var uncloneReq = new PhantomCloneReq\r\n    {\r\n        phantom_card = occupyingPhantomId,\r\n        unclone = 1,\r\n        clone_on = null\r\n    };\r\n    \r\n    MessageHub.I.Request("card/phantom_clone", uncloneReq, (resp) => {\r\n        if (resp != null && resp.code == 0)\r\n        {\r\n            step1Success = true;\r\n            \r\n            // \u7acb\u5373\u66f4\u65b0\u672c\u5730\u6570\u636e\r\n            var occupyingPhantom = PlayerCardBank.I.Get(occupyingPhantomId);\r\n            if (occupyingPhantom != null)\r\n            {\r\n                occupyingPhantom.cloneOn = "";\r\n                occupyingPhantom.level = 1;\r\n                occupyingPhantom.star = 1;\r\n                occupyingPhantom.giftLv = 0;\r\n                occupyingPhantom.giftExp = 0;\r\n            }\r\n            \r\n            var targetCard = PlayerCardBank.I.Get(targetCardId);\r\n            if (targetCard != null)\r\n            {\r\n                targetCard.clonedBy = "";\r\n            }\r\n        }\r\n    }, 10f);\r\n    \r\n    // \u7b49\u5f85\u6b65\u9aa41\u5b8c\u6210\r\n    float timeout = 10f;\r\n    while (!step1Success && timeout > 0)\r\n    {\r\n        yield return new WaitForSeconds(0.1f);\r\n        timeout -= 0.1f;\r\n    }\r\n    \r\n    if (!step1Success)\r\n    {\r\n        ShowLoading(false);\r\n        PopupManager.Show("\u9519\u8bef", "\u89e3\u9664\u590d\u5236\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5");\r\n        yield break;\r\n    }\r\n    \r\n    yield return new WaitForSeconds(0.5f);  // \u786e\u4fdd\u670d\u52a1\u5668\u5904\u7406\u5b8c\u6210\r\n    \r\n    // \u6b65\u9aa42\uff1a\u7ed1\u5b9a\u5230\u5f53\u524d\u5e7b\u5f71\u5361\r\n    bool step2Success = false;\r\n    var cloneReq = new PhantomCloneReq\r\n    {\r\n        phantom_card = phantomCard.id,\r\n        unclone = 0,\r\n        clone_on = targetCardId\r\n    };\r\n    \r\n    MessageHub.I.Request("card/phantom_clone", cloneReq, (resp) => {\r\n        if (resp != null && resp.code == 0)\r\n        {\r\n            step2Success = true;\r\n            var data = JsonUtility.FromJson<PhantomCloneResp>(resp.dataJson);\r\n            UpdateLocalData(data);\r\n        }\r\n    }, 10f);\r\n    \r\n    // \u7b49\u5f85\u6b65\u9aa42\u5b8c\u6210\r\n    timeout = 10f;\r\n    while (!step2Success && timeout > 0)\r\n    {\r\n        yield return new WaitForSeconds(0.1f);\r\n        timeout -= 0.1f;\r\n    }\r\n    \r\n    ShowLoading(false);\r\n    \r\n    if (step2Success)\r\n    {\r\n        PopupManager.Show("\u6210\u529f", "\u5207\u6362\u6210\u529f\uff01");\r\n        UpdateCurrentCloneLabel();\r\n        BuildCardList();  // \u91cd\u5efa\u5217\u8868\u4ee5\u66f4\u65b0\u5360\u7528\u72b6\u6001\r\n        onCloneSelected?.Invoke(phantomCard.cloneOn);\r\n    }\r\n}\n'})}),"\n",(0,l.jsx)(r.h2,{id:"\u7f51\u7edc\u534f\u8bae",children:"\u7f51\u7edc\u534f\u8bae"}),"\n",(0,l.jsx)(r.h3,{id:"\u8bf7\u6c42\u7ed3\u6784",children:"\u8bf7\u6c42\u7ed3\u6784"}),"\n",(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{className:"language-csharp",children:"[Serializable]\r\npublic class PhantomCloneReq\r\n{\r\n    public string phantom_card;    // \u5e7b\u5f71\u5361ID\r\n    public int unclone;           // 0=\u8bbe\u7f6e\u590d\u5236\uff0c1=\u53d6\u6d88\u590d\u5236\r\n    public string clone_on;       // \u76ee\u6807\u5361\u724cID\uff08\u53d6\u6d88\u65f6\u4e3anull\uff09\r\n}\n"})}),"\n",(0,l.jsx)(r.h3,{id:"\u54cd\u5e94\u7ed3\u6784",children:"\u54cd\u5e94\u7ed3\u6784"}),"\n",(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{className:"language-csharp",children:"[Serializable]\r\npublic class PhantomCloneResp\r\n{\r\n    public string now_clone_on;    // \u5f53\u524d\u590d\u5236\u7684\u76ee\u6807ID\r\n    public string uncloned_off;    // \u53d6\u6d88\u590d\u5236\u7684\u76ee\u6807ID\r\n    public NewStat new_stat;       // \u65b0\u7684\u5c5e\u6027\u503c\r\n    public List<AutoUnequippedGear> auto_unequipped_gears;  // \u81ea\u52a8\u5378\u4e0b\u7684\u88c5\u5907\r\n}\r\n\r\n[Serializable]\r\npublic class NewStat\r\n{\r\n    public int level;             // \u65b0\u7b49\u7ea7\r\n    public int star;              // \u65b0\u661f\u7ea7\r\n    public int gift_level;        // \u65b0\u5c01\u8d4f\u7b49\u7ea7\r\n    public int gift_progress;     // \u65b0\u5c01\u8d4f\u8fdb\u5ea6\r\n}\n"})}),"\n",(0,l.jsx)(r.h2,{id:"\u8fc7\u671f\u65f6\u95f4\u5904\u7406",children:"\u8fc7\u671f\u65f6\u95f4\u5904\u7406"}),"\n",(0,l.jsx)(r.h3,{id:"\u8fc7\u671f\u68c0\u67e5",children:"\u8fc7\u671f\u68c0\u67e5"}),"\n",(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{className:"language-csharp",children:'public void RemoveExpiredPhantoms()\r\n{\r\n    long currentTime = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds();\r\n    var toRemove = new List<string>();\r\n    \r\n    foreach (var card in PlayerCardBank.I.cards)\r\n    {\r\n        if (card.isPhantom && card.expireTime > 0 && card.expireTime < currentTime)\r\n        {\r\n            toRemove.Add(card.id);\r\n        }\r\n    }\r\n    \r\n    foreach (var id in toRemove)\r\n    {\r\n        RemoveCard(id);\r\n        Debug.Log($"[PlayerCardBankMgr] Removed expired phantom card: {id}");\r\n    }\r\n}\n'})}),"\n",(0,l.jsx)(r.h3,{id:"\u5269\u4f59\u65f6\u95f4\u663e\u793a",children:"\u5269\u4f59\u65f6\u95f4\u663e\u793a"}),"\n",(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{className:"language-csharp",children:'string GetRemainingTimeText(long expireTime)\r\n{\r\n    if (expireTime <= 0) return "\u6c38\u4e45";\r\n    \r\n    long currentTime = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds();\r\n    long remainingMs = expireTime - currentTime;\r\n    \r\n    if (remainingMs <= 0) return "\u5df2\u8fc7\u671f";\r\n    \r\n    TimeSpan timeSpan = TimeSpan.FromMilliseconds(remainingMs);\r\n    \r\n    if (timeSpan.TotalDays >= 1)\r\n        return $"{(int)timeSpan.TotalDays}\u5929";\r\n    else if (timeSpan.TotalHours >= 1)\r\n        return $"{(int)timeSpan.TotalHours}\u5c0f\u65f6";\r\n    else\r\n        return $"{(int)timeSpan.TotalMinutes}\u5206\u949f";\r\n}\n'})}),"\n",(0,l.jsx)(r.h2,{id:"ui\u6837\u5f0f",children:"UI\u6837\u5f0f"}),"\n",(0,l.jsx)(r.h3,{id:"\u9009\u4e2d\u9ad8\u4eae",children:"\u9009\u4e2d\u9ad8\u4eae"}),"\n",(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{className:"language-csharp",children:'void AddSelectedHighlight(VisualElement container)\r\n{\r\n    var cardRoot = container.Q<Button>("CardRoot");\r\n    if (cardRoot != null)\r\n    {\r\n        cardRoot.style.borderTopColor = Color.white;\r\n        cardRoot.style.borderRightColor = Color.white;\r\n        cardRoot.style.borderBottomColor = Color.white;\r\n        cardRoot.style.borderLeftColor = Color.white;\r\n        cardRoot.style.borderTopWidth = 8;\r\n        cardRoot.style.borderRightWidth = 8;\r\n        cardRoot.style.borderBottomWidth = 8;\r\n        cardRoot.style.borderLeftWidth = 8;\r\n    }\r\n    \r\n    // \u6dfb\u52a0\u6587\u5b57\u63d0\u793a\r\n    var selectedText = new Label("\u5f53\u524d\u76ee\u6807");\r\n    selectedText.style.position = Position.Absolute;\r\n    selectedText.style.bottom = 10;\r\n    selectedText.style.fontSize = 26;\r\n    selectedText.style.color = Color.white;\r\n    selectedText.style.unityFontStyleAndWeight = FontStyle.Bold;\r\n    container.Add(selectedText);\r\n}\n'})}),"\n",(0,l.jsx)(r.h3,{id:"\u88ab\u5360\u7528\u6837\u5f0f",children:"\u88ab\u5360\u7528\u6837\u5f0f"}),"\n",(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{className:"language-csharp",children:'// \u88ab\u5176\u4ed6\u5e7b\u5f71\u5361\u5360\u7528\u65f6\u663e\u793a\u534a\u900f\u660e\r\nif (!string.IsNullOrEmpty(card.clonedBy) && card.clonedBy != phantomCard.id)\r\n{\r\n    cardRoot.style.unityBackgroundImageTintColor = new Color(0.5f, 0.5f, 0.5f, 0.5f);\r\n    \r\n    // \u6dfb\u52a0\u5360\u7528\u6807\u8bb0\r\n    var occupiedLabel = new Label("\u5df2\u5360\u7528");\r\n    occupiedLabel.style.position = Position.Absolute;\r\n    occupiedLabel.style.top = Length.Percent(50);\r\n    occupiedLabel.style.fontSize = 32;\r\n    occupiedLabel.style.color = new Color(1f, 0.3f, 0.3f, 1f);\r\n    container.Add(occupiedLabel);\r\n}\n'})}),"\n",(0,l.jsx)(r.h2,{id:"\u4e8b\u4ef6\u901a\u77e5",children:"\u4e8b\u4ef6\u901a\u77e5"}),"\n",(0,l.jsx)(r.h3,{id:"\u66f4\u65b0\u901a\u77e5\u94fe",children:"\u66f4\u65b0\u901a\u77e5\u94fe"}),"\n",(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{className:"language-csharp",children:'void UpdateLocalData(PhantomCloneResp data)\r\n{\r\n    // 1. \u66f4\u65b0\u5e7b\u5f71\u5361\u6570\u636e\r\n    if (data.new_stat != null)\r\n    {\r\n        phantomCard.level = data.new_stat.level;\r\n        phantomCard.star = data.new_stat.star;\r\n        phantomCard.giftLv = data.new_stat.gift_level;\r\n        phantomCard.giftExp = data.new_stat.gift_progress;\r\n        \r\n        // \u66f4\u65b0\u88c5\u5907\u69fd\u89e3\u9501\u72b6\u6001\r\n        phantomCard.equip.weaponUnlocked = data.new_stat.gift_level >= 1;\r\n        phantomCard.equip.armorUnlocked = data.new_stat.gift_level >= 2;\r\n        phantomCard.equip.mountUnlocked = data.new_stat.gift_level >= 3;\r\n    }\r\n    \r\n    // 2. \u66f4\u65b0\u590d\u5236\u5173\u7cfb\r\n    if (!string.IsNullOrEmpty(data.uncloned_off))\r\n    {\r\n        var oldTarget = PlayerCardBank.I.Get(data.uncloned_off);\r\n        if (oldTarget != null)\r\n        {\r\n            oldTarget.clonedBy = "";\r\n            PlayerCardBankMgr.I?.RaiseCardUpdated(oldTarget.id);\r\n        }\r\n        phantomCard.cloneOn = "";\r\n    }\r\n    \r\n    if (!string.IsNullOrEmpty(data.now_clone_on))\r\n    {\r\n        phantomCard.cloneOn = data.now_clone_on;\r\n        var newTarget = PlayerCardBank.I.Get(data.now_clone_on);\r\n        if (newTarget != null)\r\n        {\r\n            newTarget.clonedBy = phantomCard.id;\r\n            PlayerCardBankMgr.I?.RaiseCardUpdated(newTarget.id);\r\n        }\r\n    }\r\n    \r\n    // 3. \u89e6\u53d1\u5e7b\u5f71\u5361\u81ea\u8eab\u7684\u66f4\u65b0\u4e8b\u4ef6\r\n    PlayerCardBankMgr.I?.RaiseCardUpdated(phantomCard.id);\r\n    \r\n    // 4. \u5f3a\u5236\u5237\u65b0UI\u7ec4\u4ef6\r\n    var cardGrid = FindObjectOfType<CardGridController>();\r\n    cardGrid?.ForceRefreshCard(phantomCard.id);\r\n    \r\n    var cardDetails = FindObjectOfType<CardDetailsController>();\r\n    cardDetails?.RefreshIfCurrent(phantomCard.id);\r\n}\n'})}),"\n",(0,l.jsx)(r.h2,{id:"\u7279\u6b8a\u89c4\u5219",children:"\u7279\u6b8a\u89c4\u5219"}),"\n",(0,l.jsx)(r.h3,{id:"1-\u4e3b\u516c\u5361\u4e0d\u80fd\u88ab\u590d\u5236",children:"1. \u4e3b\u516c\u5361\u4e0d\u80fd\u88ab\u590d\u5236"}),"\n",(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{className:"language-csharp",children:'// \u8df3\u8fc7\u4e3b\u516c\u5361\r\nif (card.id == "LORD") continue;\n'})}),"\n",(0,l.jsx)(r.h3,{id:"2-\u5e7b\u5f71\u5361\u4e0d\u80fd\u590d\u5236\u5e7b\u5f71\u5361",children:"2. \u5e7b\u5f71\u5361\u4e0d\u80fd\u590d\u5236\u5e7b\u5f71\u5361"}),"\n",(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{className:"language-csharp",children:"// \u8df3\u8fc7\u5176\u4ed6\u5e7b\u5f71\u5361\r\nif (card.isPhantom) continue;\n"})}),"\n",(0,l.jsx)(r.h3,{id:"3-\u4e00\u5bf9\u4e00\u5360\u7528\u5173\u7cfb",children:"3. \u4e00\u5bf9\u4e00\u5360\u7528\u5173\u7cfb"}),"\n",(0,l.jsxs)(r.ul,{children:["\n",(0,l.jsx)(r.li,{children:"\u4e00\u5f20\u666e\u901a\u5361\u540c\u65f6\u53ea\u80fd\u88ab\u4e00\u5f20\u5e7b\u5f71\u5361\u590d\u5236"}),"\n",(0,l.jsx)(r.li,{children:"\u5207\u6362\u76ee\u6807\u65f6\u9700\u8981\u5148\u89e3\u9664\u539f\u6709\u5360\u7528"}),"\n"]}),"\n",(0,l.jsx)(r.h3,{id:"4-\u6570\u636e\u540c\u6b65\u65f6\u673a",children:"4. \u6570\u636e\u540c\u6b65\u65f6\u673a"}),"\n",(0,l.jsxs)(r.ul,{children:["\n",(0,l.jsx)(r.li,{children:"\u590d\u5236\u76ee\u6807\u5347\u7ea7\u65f6\uff0c\u81ea\u52a8\u540c\u6b65\u5e7b\u5f71\u5361"}),"\n",(0,l.jsx)(r.li,{children:"\u590d\u5236\u76ee\u6807\u5347\u661f\u65f6\uff0c\u81ea\u52a8\u540c\u6b65\u5e7b\u5f71\u5361"}),"\n",(0,l.jsx)(r.li,{children:"\u590d\u5236\u76ee\u6807\u5c01\u8d4f\u5347\u7ea7\u65f6\uff0c\u81ea\u52a8\u540c\u6b65\u5e7b\u5f71\u5361"}),"\n"]}),"\n",(0,l.jsx)(r.h2,{id:"\u6ce8\u610f\u4e8b\u9879",children:"\u6ce8\u610f\u4e8b\u9879"}),"\n",(0,l.jsxs)(r.ol,{children:["\n",(0,l.jsxs)(r.li,{children:["\n",(0,l.jsx)(r.p,{children:(0,l.jsx)(r.strong,{children:"\u5c5e\u6027\u540c\u6b65"})}),"\n",(0,l.jsxs)(r.ul,{children:["\n",(0,l.jsx)(r.li,{children:"\u5e7b\u5f71\u5361\u7684\u6240\u6709\u5c5e\u6027\u90fd\u6765\u81ea\u590d\u5236\u76ee\u6807"}),"\n",(0,l.jsx)(r.li,{children:"\u4e0d\u4fdd\u5b58\u72ec\u7acb\u7684\u5347\u7ea7\u6570\u636e"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(r.li,{children:["\n",(0,l.jsx)(r.p,{children:(0,l.jsx)(r.strong,{children:"\u5360\u7528\u7ba1\u7406"})}),"\n",(0,l.jsxs)(r.ul,{children:["\n",(0,l.jsx)(r.li,{children:"\u4f7f\u7528clonedBy\u5b57\u6bb5\u8ddf\u8e2a\u5360\u7528\u5173\u7cfb"}),"\n",(0,l.jsx)(r.li,{children:"\u5207\u6362\u65f6\u9700\u8981\u6b63\u786e\u6e05\u7406\u5360\u7528\u72b6\u6001"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(r.li,{children:["\n",(0,l.jsx)(r.p,{children:(0,l.jsx)(r.strong,{children:"UI\u5237\u65b0"})}),"\n",(0,l.jsxs)(r.ul,{children:["\n",(0,l.jsx)(r.li,{children:"\u5207\u6362\u590d\u5236\u76ee\u6807\u540e\u9700\u8981\u5237\u65b0\u591a\u4e2aUI\u7ec4\u4ef6"}),"\n",(0,l.jsx)(r.li,{children:"\u4f7f\u7528\u4e8b\u4ef6\u901a\u77e5\u673a\u5236\u786e\u4fdd\u540c\u6b65"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(r.li,{children:["\n",(0,l.jsx)(r.p,{children:(0,l.jsx)(r.strong,{children:"\u7f51\u7edc\u8bf7\u6c42"})}),"\n",(0,l.jsxs)(r.ul,{children:["\n",(0,l.jsx)(r.li,{children:"\u5360\u7528\u51b2\u7a81\u65f6\u9700\u8981\u4e24\u6b65\u64cd\u4f5c"}),"\n",(0,l.jsx)(r.li,{children:"\u9700\u8981\u5904\u7406\u8bf7\u6c42\u5931\u8d25\u548c\u8d85\u65f6"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(r.li,{children:["\n",(0,l.jsx)(r.p,{children:(0,l.jsx)(r.strong,{children:"\u8fc7\u671f\u5904\u7406"})}),"\n",(0,l.jsxs)(r.ul,{children:["\n",(0,l.jsx)(r.li,{children:"\u5b9a\u671f\u68c0\u67e5\u8fc7\u671f\u65f6\u95f4"}),"\n",(0,l.jsx)(r.li,{children:"\u8fc7\u671f\u540e\u81ea\u52a8\u5220\u9664\u5e7b\u5f71\u5361"}),"\n"]}),"\n"]}),"\n"]})]})}function h(n={}){const{wrapper:r}={...(0,i.R)(),...n.components};return r?(0,l.jsx)(r,{...n,children:(0,l.jsx)(s,{...n})}):s(n)}},8453:(n,r,e)=>{e.d(r,{R:()=>t,x:()=>d});var a=e(6540);const l={},i=a.createContext(l);function t(n){const r=a.useContext(i);return a.useMemo(function(){return"function"==typeof n?n(r):{...r,...n}},[r,n])}function d(n){let r;return r=n.disableParentContext?"function"==typeof n.components?n.components(l):n.components||l:t(n.components),a.createElement(i.Provider,{value:r},n.children)}}}]);